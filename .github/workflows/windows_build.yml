name: Windows Build

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build-windows:
    runs-on: windows-latest
    
    defaults:
      run:
        shell: msys2 {0}

    steps:
    - uses: actions/checkout@v4

    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-imagemagick
          git
          wget
          unzip
          base-devel

    - name: Download Raylib (Static Version)
      run: |
        wget https://github.com/raysan5/raylib/releases/download/5.5/raylib-5.5_win64_mingw-w64.zip
        unzip raylib-5.5_win64_mingw-w64.zip
        mv raylib-5.5_win64_mingw-w64 raylib

    - name: Prepare Icon
      run: |
        # 1. PNG'yi Windows ICO formatına çevir
        magick icon.png -define icon:auto-resize=256,128,64,48,32,16 icon.ico
        # 2. Kaynak dosyası (.rc) oluştur
        echo "GLFW_ICON ICON \"icon.ico\"" > resource.rc
        # 3. İkonu derlenebilir nesneye (.o) çevir
        windres resource.rc -o resource.o

    - name: Compile Project
      run: |
        # Not: resource.o eklendi ve -mwindows bayrağı eklendi
        g++ main.cpp Vendor/tinyfiledialogs.c resource.o -o cpu_sim.exe -std=c++17 -I./raylib/include -L./raylib/lib -lraylib -lopengl32 -lgdi32 -lwinmm -lcomdlg32 -lole32 -static -lpthread -mwindows -Wno-write-strings

    - name: Copy Assets & Upload
      run: |
        mkdir release
        cp cpu_sim.exe release/
        cp -r Fonts release/ || echo "Fonts folder not found"
        # icon.png'ye artık exe yanında gerek yok ama yine de koyalım
        cp icon.png release/
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: 4BitCPU-Windows-Final
        path: release/
